<!DOCTYPE html>
<html>
<head>
<title>CSE407 Energy Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { font-family: Arial; padding: 20px; background: #f5f5f5; }
.card {
    background: white; padding: 20px; margin-bottom: 20px;
    border-radius: 10px; box-shadow: 0 0 10px #ccc;
}
</style>
</head>

<body>

<h1>CSE407 IoT Energy Monitoring Dashboard</h1>

<div class="card">
    <h3>Real-Time Status</h3>
    <p><b>Time:</b> <span id="time"></span></p>
    <p><b>Switch:</b> <span id="switch"></span></p>
    <p><b>Power:</b> <span id="power"></span> W</p>
    <p><b>Voltage:</b> <span id="voltage"></span> V</p>
    <p><b>Current:</b> <span id="current"></span> mA</p>
    <p><b>Energy Today:</b> <span id="kwh"></span> kWh</p>
    <p><b>Cost Today:</b> <span id="cost"></span> BDT</p>
</div>

<div class="card">
    <h3>Power Trend</h3>
    <canvas id="powerChart"></canvas>
</div>

<div class="card">
    <h3>Voltage Trend</h3>
    <canvas id="voltChart"></canvas>
</div>

<div class="card">
    <h3>Current Trend</h3>
    <canvas id="currentChart"></canvas>
</div>

<div class="card">
    <h3>Cost Trend</h3>
    <canvas id="costChart"></canvas>
</div>

<script>

let powerChart, voltChart, currentChart, costChart;

async function fetchLatest() {
    const res = await fetch("/latest");
    const d = await res.json();

    document.getElementById("time").innerHTML = d.time || "";
    document.getElementById("switch").innerHTML = d.switch || "";
    document.getElementById("power").innerHTML = d.power;
    document.getElementById("voltage").innerHTML = d.voltage;
    document.getElementById("current").innerHTML = d.current;
    document.getElementById("kwh").innerHTML = d.kwh_today.toFixed(4);
    document.getElementById("cost").innerHTML = d.cost_today.toFixed(3);
}

async function fetchHistory() {
    const res = await fetch("/history");
    const h = await res.json();

    const labels = h.map(x => x.time);
    const pw = h.map(x => x.power);
    const vo = h.map(x => x.voltage);
    const cu = h.map(x => x.current);
    const cs = h.map(x => x.cost);

    updateChart(powerChart, labels, pw);
    updateChart(voltChart, labels, vo);
    updateChart(currentChart, labels, cu);
    updateChart(costChart, labels, cs);
}

function updateChart(chart, labels, data) {
    chart.data.labels = labels;
    chart.data.datasets[0].data = data;
    chart.update();
}

function setupCharts() {
    powerChart = new Chart(document.getElementById('powerChart'), {
        type: 'line',
        data: { labels: [], datasets: [{ label: "Power (W)", data: [] }] }
    });

    voltChart = new Chart(document.getElementById('voltChart'), {
        type: 'line',
        data: { labels: [], datasets: [{ label: "Voltage (V)", data: [] }] }
    });

    currentChart = new Chart(document.getElementById('currentChart'), {
        type: 'line',
        data: { labels: [], datasets: [{ label: "Current (mA)", data: [] }] }
    });

    costChart = new Chart(document.getElementById('costChart'), {
        type: 'line',
        data: { labels: [], datasets: [{ label: "Cost (BDT)", data: [] }] }
    });
}

setupCharts();
setInterval(fetchLatest, 2000);
setInterval(fetchHistory, 4000);

</script>
</body>
</html>
